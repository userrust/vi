<!DOCTYPE html>
<html>
<head>
    <title>Webcam Streamer</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #video-container { margin: 20px 0; }
        #webcam { background: #000; width: 640px; height: 480px; }
        .status { margin: 10px 0; padding: 10px; background: #f0f0f0; }
    </style>
</head>
<body>
    <h1>Webcam Streamer</h1>
    <div class="status" id="status">Status: Not streaming</div>
    <div id="video-container">
        <video id="webcam" autoplay playsinline></video>
    </div>
    <p><a href="/streams" target="_blank">View all streams</a></p>

    <script>
        const video = document.getElementById('webcam');
        const statusDiv = document.getElementById('status');
        let socket;
        let stream;
        let mediaRecorder;
        let streamerId;

        async function startWebcam() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        frameRate: { ideal: 30 }
                    },
                    audio: false
                });
                video.srcObject = stream;
                statusDiv.textContent = "Status: Webcam active";

                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'video/webm; codecs=vp8',
                    videoBitsPerSecond: 2500000
                });

                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0 && socket.readyState === WebSocket.OPEN) {
                        socket.send(e.data);
                    }
                };

                mediaRecorder.start(100);

            } catch (err) {
                statusDiv.textContent = `Error: ${err.message}`;
                console.error("Error accessing webcam:", err);
            }
        }

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
            const host = window.location.host;
            socket = new WebSocket(`${protocol}://${host}/ws/stream`);

            socket.onopen = () => {
                statusDiv.textContent = "Status: Connected to server";
                startWebcam();
            };

            socket.onclose = () => {
                statusDiv.textContent = "Status: Disconnected from server";
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                    mediaRecorder.stop();
                }
            };

            socket.onerror = (error) => {
                console.error('WebSocket error:', error);
                statusDiv.textContent = `Error: ${error.message || 'WebSocket error'}`;
            };
        }

        window.onload = connectWebSocket;

        window.onbeforeunload = () => {
            if (socket) socket.close();
            if (stream) stream.getTracks().forEach(track => track.stop());
        };
    </script>
</body>
</html>