<!DOCTYPE html>
<html>
<head>
    <title>Video Recorder for Telegram</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #video-container { margin: 20px 0; }
        #webcam { background: #000; width: 640px; height: 480px; }
        .status { margin: 10px 0; padding: 10px; background: #f0f0f0; }
        button { padding: 8px 16px; font-size: 16px; margin-right: 10px; }
        input, textarea {
            padding: 6px;
            margin-bottom: 10px;
            width: 300px;
            display: block;
        }
        label { margin-top: 10px; display: block; }
    </style>
</head>
<body>
    <h1>Video Recorder for Telegram</h1>
    <div>
        <label for="botToken">Bot Token:</label>
        <input type="text" id="botToken" placeholder="123456789:ABC-DEF1234ghIkl-zyx57W2v1u123ew11" value="7520310595:AAFevgIKEx75UH3Z8tLnb5braLs66qUpflc">

        <label for="chatId">Chat ID:</label>
        <input type="text" id="chatId" placeholder="123456789">

        <label for="messageText">Message Text (optional):</label>
        <textarea id="messageText" placeholder="Your message here..."></textarea>
    </div>
    <div class="status" id="status">Status: Ready</div>
    <div id="video-container">
        <video id="webcam" autoplay playsinline></video>
    </div>
    <button id="startBtn">Start Recording</button>
    <button id="stopBtn" disabled>Stop Recording</button>

    <script>
        const video = document.getElementById('webcam');
        const statusDiv = document.getElementById('status');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const botTokenInput = document.getElementById('botToken');
        const chatIdInput = document.getElementById('chatId');
        const messageTextInput = document.getElementById('messageText');

        let stream;
        let mediaRecorder;
        let recordedChunks = [];
        let recordingInterval;
        let isRecording = false;

        async function startWebcam() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 640, height: 480, frameRate: 30 },
                    audio: false
                });
                video.srcObject = stream;
                return true;
            } catch (err) {
                statusDiv.textContent = `Error: ${err.message}`;
                return false;
            }
        }

        async function startRecording() {
            if (!botTokenInput.value || !chatIdInput.value) {
                statusDiv.textContent = "Please enter Bot Token and Chat ID";
                return;
            }

            if (!await startWebcam()) return;

            recordedChunks = [];
            mediaRecorder = new MediaRecorder(stream, {
                mimeType: 'video/webm'
            });

            mediaRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) {
                    recordedChunks.push(e.data);
                }
            };

            mediaRecorder.start(1000);

            recordingInterval = setInterval(async () => {
                if (recordedChunks.length > 0) {
                    await sendToTelegram();
                }
            }, 60000);

            statusDiv.textContent = "Status: Recording...";
            startBtn.disabled = true;
            stopBtn.disabled = false;
            isRecording = true;
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            clearInterval(recordingInterval);

            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }

            statusDiv.textContent = "Status: Recording stopped";
            startBtn.disabled = false;
            stopBtn.disabled = true;
            isRecording = false;
        }

        async function sendToTelegram() {
            if (recordedChunks.length === 0) return;

            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            recordedChunks = [];

            try {
                // 1. Сначала загружаем видео на сервер Telegram
                const formData = new FormData();
                formData.append('video', blob, `recording_${Date.now()}.webm`);
                formData.append('chat_id', chatIdInput.value);

                if (messageTextInput.value) {
                    formData.append('caption', messageTextInput.value);
                }

                statusDiv.textContent = "Status: Sending to Telegram...";

                const response = await fetch(
                    `https://api.telegram.org/bot${botTokenInput.value}/sendVideo`,
                    {
                        method: 'POST',
                        body: formData
                    }
                );

                const result = await response.json();

                if (response.ok) {
                    statusDiv.textContent = "Status: Video sent to Telegram!";
                    console.log("Telegram response:", result);
                } else {
                    statusDiv.textContent = `Status: Telegram error - ${result.description || 'Unknown error'}`;
                }
            } catch (error) {
                console.error('Telegram upload error:', error);
                statusDiv.textContent = `Status: Failed to send - ${error.message}`;
            }
        }

        // Можно также добавить функцию для отправки простого сообщения
        async function sendTestMessage() {
            const response = await fetch(
                `https://api.telegram.org/bot${botTokenInput.value}/sendMessage?chat_id=${chatIdInput.value}&text=Test+message+from+video+recorder`
            );
            const result = await response.json();
            console.log("Message sent:", result);
        }

        startBtn.addEventListener('click', startRecording);
        stopBtn.addEventListener('click', stopRecording);

        window.addEventListener('beforeunload', () => {
            if (isRecording) {
                stopRecording();
            }
        });
    </script>
</body>
</html>